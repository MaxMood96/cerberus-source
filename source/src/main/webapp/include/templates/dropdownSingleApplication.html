<template id="tpl-dropdown-application">
  <div class="relative w-full">

    <!-- Bouton principal -->
    <div @click.stop="toggle()"
            :id="id + '-mainbutton'"
         class="flex h-10 items-center justify-between w-full rounded-md border px-3 py-2 text-sm gap-2
                transition-all cursor-pointer select-none
                dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700
                bg-white border-slate-300 text-slate-900 hover:bg-slate-100">
      <span x-text="selectedLabel()"></span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2"
           fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
      </svg>
    </div>

    <!-- Dropdown -->
    <template x-teleport="body">
      <div x-show="open"
           @click.away="open = false"
           x-transition
           class="absolute rounded-md border shadow-lg z-50
                  dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300
                  bg-white border-slate-300 text-slate-900"
           :style="{ top: `${top}px`, left: `${left}px`, width: `${width}px` }">

        <!-- Barre de recherche -->
        <div class="p-2 border-b dark:border-slate-700">
          <input type="text" x-model="search" placeholder="Search..."
                 class="w-full text-sm border rounded px-2 py-1 dark:bg-slate-700 dark:border-slate-600"
                 @keydown.escape.stop="open = false">
        </div>

        <!-- Liste filtrÃ©e -->
        <div class="max-h-52 overflow-auto">
          <template x-if="filteredItems().length > 0">
            <template x-for="item in filteredItems()" :key="item">
              <button type="button"
                      @click="select(item)"
                      class="w-full text-left px-3 py-2 text-sm
                             hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                <span x-text="item"></span>
              </button>
            </template>
          </template>

          <template x-if="filteredItems().length === 0">
            <div class="px-3 py-2 text-sm text-gray-500 dark:text-slate-400 italic">
              No matching results
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>
</template>
<script>
  function applicationDropdown(config = {}) {
    return {
      id: config.id||'application',
      open: false,
      items: [],
      search: '',
      selected: '',
      top: 0, left: 0, width: 0,
      model: config.model ?? '',

      init() {
        // Clone the template into the component element
        const tpl = document.getElementById('tpl-dropdown-application').content.cloneNode(true);
        this.$el.appendChild(tpl);

        this.loadApplications();

        // Update dropdown position
        this.updatePosition();

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (this.open && !this.$el.contains(e.target)) {
            this.open = false;
          }
        });

        // Update position on scroll or resize
        window.addEventListener('scroll', () => { if (this.open) this.updatePosition(); }, true);
        window.addEventListener('resize', () => { if (this.open) this.updatePosition(); });
      },

      loadApplications() {
        fetch('ReadApplication')
                .then(resp => resp.json())
                .then(data => {
                  this.items = data.contentTable.map(c => c.application);
                })
                .catch(err => console.error("Failed to load applications:", err));
      },

      /**
       * Toggle dropdown open/close
       */
      toggle() {
        this.open = !this.open;
        this.updatePosition();
      },

      /**
       * Calculate dropdown position based on main button
       */
      updatePosition() {
        const btn = document.getElementById(this.id + '-mainbutton');
        if (!btn) return;
        const rect = btn.getBoundingClientRect();
        this.top = rect.bottom + window.scrollY + 5; // dropdown appears 5px below
        this.left = rect.left + window.scrollX;
        this.width = Math.max(rect.width, 320);
      },

      filteredItems() {
        const query = this.search.toLowerCase();
        return this.items.filter(i => i.toLowerCase().includes(query));
      },

      select(item) {
        this.selected = item;
        this.model = item;
        if (config.model !== undefined) config.model = item;
        this.open = false;
        this.$dispatch('update-application', item);
      },

      selectedLabel() {
        return this.selected || '-- Select Application --';
      }
    }
  }
</script>